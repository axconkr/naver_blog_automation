import google.generativeai as genai
from openpyxl import load_workbook
from datetime import datetime
from dotenv import load_dotenv
import os
import glob

# .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# Gemini API Key ì„¤ì •
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

if not GEMINI_API_KEY:
    raise ValueError(".env íŒŒì¼ì—ì„œ GEMINI_API_KEYë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

# Gemini API ì„¤ì •
genai.configure(api_key=GEMINI_API_KEY)

# ëª¨ë¸ ì„¤ì •
model = genai.GenerativeModel('gemini-2.5-flash')

def generate_blog_content(main_keyword, sub_keyword, word_count_limit_per_paragraph=120, examples_stats_quotes=""):
    """
    Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê³ ê¸‰ í”„ë¡¬í”„íŠ¸ ê·œì¹™ì— ë”°ë¼ ë¸”ë¡œê·¸ ë³¸ë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        main_keyword (str): ì£¼ìš” í‚¤ì›Œë“œ
        sub_keyword (str): ì„¸ë¶€ í‚¤ì›Œë“œ
        word_count_limit_per_paragraph (int): ë‹¨ë½ë‹¹ ê¸€ì ìˆ˜ ì œí•œ (ê¸°ë³¸ê°’: 120)
        examples_stats_quotes (str): ë„£ê³  ì‹¶ì€ ì‚¬ë¡€/í†µê³„/ì¸ìš© (ê¸°ë³¸ê°’: ë¹ˆ ë¬¸ìì—´)
    
    Returns:
        str: ìƒì„±ëœ ë¸”ë¡œê·¸ ë³¸ë¬¸
    """
    prompt = f"""ë‹¹ì‹ ì€ **ë„¤ì´ë²„ ìƒìœ„ë…¸ì¶œ SEO ì „ë¬¸ ë¸”ë¡œê·¸ ì‘ê°€ì´ì, ë…ìì˜ ê°ì„±ì„ ìê·¹í•˜ëŠ” ìŠ¤í† ë¦¬í…”ëŸ¬**ì…ë‹ˆë‹¤. 
ëª©í‘œëŠ” ê²€ìƒ‰ì—”ì§„ê³¼ ì‚¬ëŒ ëª¨ë‘ë¥¼ ì‚¬ë¡œì¡ëŠ” ê¸€ì„ ì‘ì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. 
SEO ì›ì¹™ì— ë”°ë¼ êµ¬ì¡°ë¥¼ ë§Œë“¤ê³ , ê·¸ ì•ˆì— ê°ê°ì ì´ê³  ê³µê°ê°€ëŠ” ìŠ¤í† ë¦¬ë¥¼ ë‹´ì•„ ë„¤ì´ë²„ 1í˜ì´ì§€ì— ë…¸ì¶œë˜ë„ë¡ í•©ë‹ˆë‹¤. 

=== ì‹¤í–‰ ì›Œí¬í”Œë¡œìš° ===
1) ì›¹ê²€ìƒ‰:
- ì£¼ìš” í‚¤ì›Œë“œì™€ ì„¸ë¶€ í‚¤ì›Œë“œë¡œ ë°˜ë“œì‹œ ê²€ìƒ‰í•œë‹¤.
- ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¶œì²˜ 3~5ê°œë¥¼ ìš”ì•½í•œë‹¤.
- ê¸°ì‚¬/ë¸”ë¡œê·¸ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³  ì‚¬ì‹¤ë§Œ ì¶”ì¶œí•œë‹¤.
- ë¶ˆí™•ì‹¤í•œ ê²½ìš° "í™•ì¸ë˜ì§€ ì•Šì•˜ë‹¤"ê³  ëª…ì‹œí•œë‹¤.
- âš ï¸ ì›¹ê²€ìƒ‰ ê²°ê³¼ëŠ” ì‚¬ì‹¤ í™•ì¸ê³¼ ì•„ì´ë””ì–´ ì°¸ì¡°ì—ë§Œ ì‚¬ìš©í•˜ë©°,
ë³¸ë¬¸ì—ëŠ” "ì¶œì²˜: â€¦", "[1] â€¦" ê°™ì€ ì¸ìš© í‘œê¸°ë¥¼ ë„£ì§€ ì•ŠëŠ”ë‹¤.
ë°˜ë“œì‹œ ë¸”ë¡œê·¸ í†¤ìœ¼ë¡œ ì¬êµ¬ì„±í•œë‹¤.
2) í•„ìˆ˜ í˜•íƒœì†Œ ìë™ ì¶”ì²œ: 
- ì›¹ê²€ìƒ‰ ìš”ì•½, ì£¼ìš” í‚¤ì›Œë“œ, ì„¸ë¶€ í‚¤ì›Œë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ
ëª…ì‚¬/í˜•ìš©ì‚¬/ë™ì‚¬ ì¤‘ì‹¬ì˜ **í•„ìˆ˜ í˜•íƒœì†Œ 3~5ê°œ**ë¥¼ ìë™ìœ¼ë¡œ ì„ ì •í•œë‹¤.
- ê¸€ ì „ì²´ì—ì„œ ìµœì†Œ 1íšŒ ì´ìƒ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•œë‹¤.
3) ê¸€ ì‘ì„±:
- ê²€ìƒ‰ ìš”ì•½ + ì£¼ìš” í‚¤ì›Œë“œ + ì„¸ë¶€ í‚¤ì›Œë“œ + ìë™ ì¶”ì²œëœ í•„ìˆ˜ í˜•íƒœì†Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•œë‹¤.
- ì¶”ì¸¡ ê¸ˆì§€, ë³µë¶™ ê¸ˆì§€. ì‚¬ì‹¤ì€ ì¬êµ¬ì„±í•˜ì—¬ ë¸”ë¡œê·¸ í†¤ìœ¼ë¡œ í’€ì–´ë‚¸ë‹¤.

=== ê¸€ì“°ê¸° ê·œì¹™ ===
1. êµ¬ì¡°:
- ê¸€ ì „ì²´ëŠ” 'ë¬¸ì œ ìƒí™© â†’ ì›ì¸ ë¶„ì„ â†’ í™œìš©ë²•/ë°©ë²•/íŒ â†’ FAQ â†’ ë§ˆë¬´ë¦¬' íë¦„ì„ ë”°ë¥¸ë‹¤.
- ë‚´ë¶€ êµ¬ì¡°ëŠ” ìœ ì§€í•˜ì§€ë§Œ "ë¬¸ì œ/í•´ê²°/ê°€ì´ë“œ" ê°™ì€ ë©”íƒ€ì–´ëŠ” ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ì†Œì œëª©ì€ ë³¸ë¬¸ ë‚´ìš©ê³¼ ì—°ê´€ëœ í•µì‹¬ ë‹¨ì–´Â·í–‰ë™Â·ê²°ê³¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì§“ëŠ”ë‹¤.
2. ì„œë‘:
- TL;DR ìš”ì•½ì„ "ìš”ì•½:"ìœ¼ë¡œ ì‹œì‘í•´ 1~2ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•œë‹¤.
3. ë¬¸ì²´:
- ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ í†¤ì„ ìœ ì§€í•œë‹¤.
- ëª¨ë“  ë‹¨ë½ì€ {word_count_limit_per_paragraph}ì ì´í•˜ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•œë‹¤.
- ë‹¨ë½ì€ 2~3ë¬¸ì¥, ì¤„ë°”ê¿ˆì„ ìì£¼ ë„£ì–´ ê°€ë…ì„±ì„ ë†’ì¸ë‹¤.
- ì˜¤ê°ì„ ìê·¹í•˜ëŠ” í‘œí˜„, ë°©í–¥/ìƒ‰ê¹”/ì˜¨ë„ê°€ ëŠê»´ì§€ëŠ” ë‹¨ì–´ë¥¼ í™œìš©í•œë‹¤.
4. SEO:
- ì£¼ìš” í‚¤ì›Œë“œëŠ” ë³¸ë¬¸ ì „ì²´ì— ê³ ë¥´ê²Œ 5íšŒ ì´ìƒ ë“±ì¥í•´ì•¼ í•œë‹¤.
- ì œëª©, ì²« ë¬¸ë‹¨, ê²°ë¡ ì—ëŠ” ë°˜ë“œì‹œ í¬í•¨í•œë‹¤.
- ì„¸ë¶€ í‚¤ì›Œë“œëŠ” ì†Œì œëª©, ë‹¨ë½ ì²« ë¬¸ì¥, FAQ, ê²°ë¡ ì— ë°˜ë“œì‹œ í¬í•¨í•œë‹¤.
- í•„ìˆ˜ í˜•íƒœì†ŒëŠ” Geminiê°€ ìë™ ì¶”ì²œí•œ ë‹¨ì–´ë¥¼ ë°˜ë“œì‹œ 1íšŒ ì´ìƒ í¬í•¨í•œë‹¤.
5. ë¦¬ìŠ¤íŠ¸:
- ë°©ë²•, íŒ, ì ˆì°¨ëŠ” ìˆ«ì/ë¶ˆë¦¿í˜•ìœ¼ë¡œ ì •ë¦¬í•œë‹¤.
6. FAQ:
- ë°˜ë“œì‹œ í¬í•¨í•œë‹¤. (ìµœì†Œ 1ê°œ ì´ìƒ)
- "ë§ì´ë“¤ ê¶ê¸ˆí•´í•˜ì‹œëŠ” ë¶€ë¶„" ê°™ì€ ë©”íƒ€ ë¬¸êµ¬ ì—†ì´, Q/A í˜•ì‹ìœ¼ë¡œ ë°”ë¡œ ì‘ì„±í•œë‹¤.
7. ì‚¬ë¡€/ë°ì´í„°:
- ìµœì‹  í†µê³„ë‚˜ ìƒí™œ ì‚¬ë¡€ë¥¼ 1~2ê°œ ë„£ëŠ”ë‹¤. ì—†ìœ¼ë©´ í•©ë¦¬ì  ê°€ìƒ ì‚¬ë¡€ë¥¼ ì‘ì„±í•œë‹¤. (ì œê³µëœ ì‚¬ë¡€/í†µê³„/ì¸ìš©: {examples_stats_quotes})
8. ë§ˆë¬´ë¦¬:
- ì¦‰ì‹œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” í–‰ë™ íŒì„ ì œì‹œí•œë‹¤.
- ëŒ“ê¸€ ìœ ë„ ë¬¸ì¥ì„ í¬í•¨í•œë‹¤.
- ê´€ë ¨ í•´ì‹œíƒœê·¸ 5~8ê°œë¥¼ ì¶”ì²œí•œë‹¤.

=== ì‚¬ìš©ì ì…ë ¥ê°’ ===
- ì£¼ìš” í‚¤ì›Œë“œ: {main_keyword}
- ì„¸ë¶€ í‚¤ì›Œë“œ: {sub_keyword}
- ì›í•˜ëŠ” ê¸€ì ìˆ˜: 500ì ì´ë‚´ (ì „ì²´ ê¸€ì ìˆ˜, ê° ë‹¨ë½ì€ {word_count_limit_per_paragraph}ì ì´ë‚´)
- ë„£ê³  ì‹¶ì€ ì‚¬ë¡€/í†µê³„/ì¸ìš©: {examples_stats_quotes}

ğŸ”µ ì¶œë ¥ êµ¬ì¡° ì˜ˆì‹œ (ì‹¤ì œ ì¶œë ¥ì€ ì´ ì˜ˆì‹œë¥¼ ë”°ë¥´ë˜, ë©”íƒ€ì–´ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŒ)
[ì œëª©: {main_keyword} í¬í•¨, 35ì ì´ë‚´]
ìš”ì•½: ì´ ê¸€ì€ {main_keyword}ì™€ ê´€ë ¨ëœ ê³ ë¯¼ê³¼ í•´ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤.

{{ì†Œì œëª©1: ë…ìì˜ ê³ ë¯¼ì´ë‚˜ ë¬¸ì œ ìƒí™©ì„ ë“œëŸ¬ë‚´ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„}}
{{120ì ì´í•˜ ë‹¨ë½}}

{{ì†Œì œëª©2: {sub_keyword}ê°€ í¬í•¨ëœ ì œëª©}}
{{120ì ì´í•˜ ë‹¨ë½}}

{{ì†Œì œëª©3: ì›ì¸ì´ë‚˜ ë°°ê²½ ì„¤ëª…}}
{{120ì ì´í•˜ ë‹¨ë½}}

{{ì†Œì œëª©4: í™œìš©ë²•/ë°©ë²•/íŒ}}
1) â€¦
2) â€¦
3) â€¦

{{ì†Œì œëª©5: ì‚¬ë¡€/ë°ì´í„° ì œì‹œ}}
{{120ì ì´í•˜ ë‹¨ë½}}

Q. {sub_keyword} ê´€ë ¨ ì§ˆë¬¸
A. {{ê°„ë‹¨í•œ í•´ê²°ì±…/íŒ}}

ì˜¤ëŠ˜ë¶€í„° ì‹¤ì²œí•´ ë³´ì„¸ìš”
{{ì¦‰ì‹œ ì‹¤í–‰ íŒ 3~5ê°œ + {main_keyword}/{sub_keyword} í¬í•¨ ê²°ë¡ }}

ì¶”ì²œ í•´ì‹œíƒœê·¸: #{main_keyword} #{sub_keyword} â€¦ (5~8ê°œ)

âœ… ì¶œë ¥ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (G ë‚´ë¶€ì ìœ¼ë¡œ í™œìš©)
[O] ì£¼ìš” í‚¤ì›Œë“œ: ì œëª©/ì²« ë¬¸ë‹¨/ê²°ë¡  í¬í•¨ 
[O] ì„¸ë¶€ í‚¤ì›Œë“œ: ì†Œì œëª©/ì²« ë¬¸ì¥/FAQ/ê²°ë¡  í¬í•¨ 
[O] í•„ìˆ˜ í˜•íƒœì†Œ: gemini ìë™ ì¶”ì²œ ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ 
[O] í‚¤ì›Œë“œ ë¶„í¬: ë³¸ë¬¸ ì „ì²´ì— ê³ ë¥´ê²Œ 5íšŒ ì´ìƒ 
[O] ì†Œì œëª©: ë©”íƒ€ í‘œí˜„ ê¸ˆì§€, ë³¸ë¬¸ ë‚´ìš© ê¸°ë°˜ ëª…ëª… 
[O] ê°€ë…ì„±: {word_count_limit_per_paragraph}ì ì´í•˜ ë¬¸ì¥, 2~3ë¬¸ì¥ ë‹¨ë½, ì¤„ë°”ê¿ˆ ë°˜ì˜ 
[O] ì •ë³´ì˜ ì§ˆ: ì›¹ ê²€ìƒ‰ ì‚¬ì‹¤ ê¸°ë°˜ 

â˜‘ï¸ Pain Point: ë…ìì˜ ê³ ë¯¼ 2~3ê°œ ì–¸ê¸‰ + í•´ê²°ì±… ì œì‹œ 
â˜‘ï¸ ê°ì„± í†¤: ì˜¤ê° ë¬˜ì‚¬, ë°©í–¥/ìƒ‰ê¹”/ì˜¨ë„ ë‹¨ì–´ í™œìš© 
â˜‘ï¸ ì›¹ê²€ìƒ‰ ë°˜ì˜: ì‚¬ì‹¤ë§Œ ì°¸ì¡°, ë³µë¶™ ê¸ˆì§€, ì¶œì²˜ í‘œê¸° ê¸ˆì§€ 
â˜‘ï¸ í•„ìˆ˜ í˜•íƒœì†Œ: Gemini ìë™ ì¶”ì²œ 3~5ê°œ ë‹¨ì–´ ì ìš©"""
    
    try:
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        raise Exception(f"API í˜¸ì¶œ ì‹¤íŒ¨: {e}")

def find_blog_file():
    """
    í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ blog+ë‚ ì§œ.xlsx íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
    
    Returns:
        str: íŒŒì¼ ê²½ë¡œ
    """
    current_dir = os.getcwd()
    # blogë¡œ ì‹œì‘í•˜ê³  .xlsxë¡œ ëë‚˜ëŠ” íŒŒì¼ ì°¾ê¸°
    pattern = os.path.join(current_dir, "blog*.xlsx")
    files = glob.glob(pattern)
    
    if not files:
        raise FileNotFoundError("blog+ë‚ ì§œ.xlsx íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
    # ê°€ì¥ ìµœê·¼ íŒŒì¼ ë°˜í™˜ (ì—¬ëŸ¬ ê°œ ìˆì„ ê²½ìš°)
    latest_file = max(files, key=os.path.getmtime)
    return latest_file

def main():
    # 1. blog+ë‚ ì§œ.xlsx íŒŒì¼ ì—´ê¸°
    try:
        blog_file = find_blog_file()
        print(f"ì—‘ì…€ íŒŒì¼ ì—´ê¸°: {blog_file}")
        wb = load_workbook(blog_file)
        ws = wb.active
    except Exception as e:
        print(f"íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜: {e}")
        return
    
    # 2. Aì—´(ì œëª©)ì˜ ëª¨ë“  í–‰ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    titles = []
    max_row = ws.max_row
    
    for row in range(2, max_row + 1):  # 2í–‰ë¶€í„° ì‹œì‘ (1í–‰ì€ í—¤ë”)
        title = ws[f'A{row}'].value
        if title:  # ì œëª©ì´ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
            titles.append((row, title))
    
    if not titles:
        print("ì²˜ë¦¬í•  ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤.")
        wb.close()
        return
    
    print(f"ì´ {len(titles)}ê°œì˜ ì œëª©ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.\n")
    
    # 3-4. ê° ì œëª©ì„ Gemini APIì— ì…ë ¥í•˜ì—¬ ë³¸ë¬¸ ìƒì„± ë° Bì—´ì— ê¸°ë¡
    for row, title in titles:
        try:
            # ì§„í–‰ ìƒí™© ì¶œë ¥
            print(f"í˜„ì¬ {row}í–‰: {title}")
            
            # ì œëª©ì—ì„œ ì£¼ìš” í‚¤ì›Œë“œì™€ ì„¸ë¶€ í‚¤ì›Œë“œ ì¶”ì¶œ
            # ì œëª© ì „ì²´ë¥¼ ì£¼ìš” í‚¤ì›Œë“œë¡œ ì‚¬ìš©í•˜ê³ , ì œëª©ì˜ í•µì‹¬ ë¶€ë¶„ì„ ì„¸ë¶€ í‚¤ì›Œë“œë¡œ ì‚¬ìš©
            main_keyword = title
            # ì œëª©ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ (ì˜ˆ: "íŒŒì´ì¬ ì´ˆë³´ìë¥¼ ìœ„í•œ ì™„ë²½ ê°€ì´ë“œ 2026" -> "íŒŒì´ì¬ ê°€ì´ë“œ")
            # ê°„ë‹¨í•˜ê²Œ ì œëª©ì˜ ì•ë¶€ë¶„ì„ ì„¸ë¶€ í‚¤ì›Œë“œë¡œ ì‚¬ìš©
            words = title.split()
            if len(words) > 2:
                sub_keyword = " ".join(words[:2])  # ì• 2ê°œ ë‹¨ì–´ë¥¼ ì„¸ë¶€ í‚¤ì›Œë“œë¡œ
            else:
                sub_keyword = title  # ë‹¨ì–´ê°€ ì ìœ¼ë©´ ì „ì²´ë¥¼ ì„¸ë¶€ í‚¤ì›Œë“œë¡œ
            
            # Gemini APIë¡œ ë³¸ë¬¸ ìƒì„±
            # ê¸°ë³¸ê°’: ë‹¨ë½ë‹¹ 120ì, ì‚¬ë¡€/í†µê³„/ì¸ìš©ì€ ë¹ˆ ë¬¸ìì—´
            content = generate_blog_content(
                main_keyword=main_keyword,
                sub_keyword=sub_keyword,
                word_count_limit_per_paragraph=120,
                examples_stats_quotes=""
            )
            
            # Bì—´ì— ë³¸ë¬¸ ê¸°ë¡
            ws[f'B{row}'] = content
            
            print(f"  âœ“ ë³¸ë¬¸ ìƒì„± ì™„ë£Œ\n")
            
        except Exception as e:
            # ì˜ˆì™¸ ë°œìƒ ì‹œ í–‰ ë²ˆí˜¸ + ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥í•˜ê³  ë‹¤ìŒ í–‰ìœ¼ë¡œ
            print(f"  âœ— ì˜¤ë¥˜ ë°œìƒ: {e}\n")
            continue
    
    # 6. ìˆ˜ì •ëœ ë°ì´í„°ë¥¼ ì›ë³¸ íŒŒì¼ì— ë®ì–´ì“°ê¸° ë°©ì‹ìœ¼ë¡œ ì €ì¥
    try:
        wb.save(blog_file)
        print(f"íŒŒì¼ ì €ì¥ ì™„ë£Œ: {blog_file}")
    except Exception as e:
        print(f"íŒŒì¼ ì €ì¥ ì˜¤ë¥˜: {e}")
    finally:
        wb.close()
    
    print("\nì‘ì—… ì™„ë£Œ!")

if __name__ == "__main__":
    main()
